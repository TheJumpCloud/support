name: PowerShell Module CI

env:
  # Set the release type of the release, valid values are 'major', 'minor' or 'patch'
  # override version boolean. If specified, valid vlaues are 'true' or 'false'
  OVERRIDE_VERSION: "false"
on:
  pull_request:
    # Sequence of patterns matched against refs/heads
    branches:
      - "master"
    paths:
      - "PowerShell/Deploy/**"
      - "PowerShell/JumpCloud Module/**"
      - "PowerShell/ModuleChangelog.md"
    types: [opened, synchronize, reopened, labeled, unlabeled]
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true
jobs:
  Display-Vars:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR Labels
        id: label-check-pwsh
        shell: pwsh
        run: |
          $PR_LABEL_LIST=$(curl -s "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/labels" | jq -r '.[].name')
          echo "PR_LABEL_LIST=$PR_LABEL_LIST" >> $env:GITHUB_ENV
          write-host $PR_LABEL_LIST
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: set env variables
        shell: pwsh
        run: |
          $split_labels = $env:PR_LABEL_LIST.split(" ")
          foreach ($label in $env:split_labels) {
            Write-Host "determining version from: $label"
            switch ($label) {
              ('minor') {
                write-host "release type is minor"
                echo "RELEASE_TYPE=$label" >> $env:GITHUB_ENV
              }
              ('major') {
                write-host "release type is major"
                echo "RELEASE_TYPE=$label" >> $env:GITHUB_ENV
              }
              ('patch') {
                write-host "release type is patch"
                echo "RELEASE_TYPE=$label" >> $env:GITHUB_ENV
              }
            }
          }
      - name: show the refs
        shell: bash
        run: |
          echo github.base_ref ${{ github.base_ref }}
          echo github.head_ref ${{ github.head_ref }}
          echo github.ref ${{ github.ref }}
          echo github.ref_name ${{ github.ref_name }}
          echo $env:RELEASE_TYPE

  Filter-Branch:
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'PowerShell Module')
    steps:
      - run: echo "Building JumpCloud Module Event 'JumpCloudModule_'"

  Next-Step:
    needs: Filter-Branch
    runs-on: ubuntu-latest
    steps:
      - name: Hello World
        run: echo "hello"
